在上一篇文章中，我们已经搭建好了KWS-SOC的仿真平台，完成了SoC的拓展与仿真。本文将继续介绍KWS-SoC的开发过程。本文涉及到预处理IP的集成，KWS IP的更新，软件控制流程和FPGA的验证，下面将依次介绍
## 预处理IP的集成
### 算法介绍
预处理算法，即音频特征MFCC（Mel-scaleFrequency Cepstral Coefficients，梅尔倒谱系数）的提取，其基本流程如下图所示  
![Pre-processing流程](http://10.134.141.124:8080/yintianyu/iaclab-zhihu/raw/master/figs/bchen/preprocessing.png)  
音频采集后，第一步首先通过**零值填充、分帧、加窗处理，然后通过FFT计算一维DFT，再进行平方**得到能量谱  
第二步将能量谱通过**Mel频率滤波器组**，以消除谐波，突显音频特征的共振峰  
第三步将计算滤波器输出的**对数能量**    
最后进行**DCT（Discrete Cosine Transform, 离散余弦变换）**，计算出L阶MFCC系数  
本实验将1s的采样音频数据预处理后，得到49帧，10阶MFCC系数的预处理数据 
### HLS实现与优化策略
为了能将音频预处理功能集成在开发板上，本实验通过Vivado HLS工具将算法进行快速硬件实现，在KWS-SoC开源工程第一个版本中，reference_model中的my_audio.py已经初步实现了预处理的功能，以此为基础，我们继续做了如下开发  
- **查表法计算cos函数值**  
介绍查表法的实现,贴代码块
- **FFT IP核的使用**  
介绍HLS提供的FFT ip核，贴代码块
- **HLS流水线优化**  
介绍预处理流程中，在通过带通滤波器时的大量循环影响了运行速度，因此在HLS里采用pipeline(或者unroll)展开
- **接口定义与输入输出方式**  
介绍IP核基于AXIS（或者AXI4）协议，以及输入输出的数据端口和数据流输入输出顺序
- **IP核生成与资源消耗**  
介绍IP核的资源占用，贴张图或者资源报告表
- **集成到SoC low-speed总线上**  
介绍IP核在SoC中的位置，以及采用了转换IP
- **加速比**  
介绍sdk提供的timer.h驱动，比较直接在core中预处理和用IP处理的时间，贴个柱状图

## KWS IP的更新
在上一版本的KWS-SoC中，采用的是单精度的DS-RNN网络对预处理后的数据进行计算。由于预处理的IP核集成在SoC上以后，再同时集成该IP核，综合后会报告开发板资源不足（LutRAM和Bram不足），因此本实验更换了
基于**1D-DS（一维深度可分离卷积）算法的IP核**，该算法和HLS的实现代码由IA&C Lab的郑日雍师兄开发。  
另外，为了进一步减小资源消耗，本实验在HLS实现过程中，将三种输入数据类型定义为**半精度（half）类型**。  
新的IP核的数据输入方式和第一个版本的IP核一致，具体可以参考之前的帖子：  
[KWS-SoC——基于Wujian100的SoC拓展开发笔记](https://zhuanlan.zhihu.com/p/145148340)  
最终，本实验将预处理加速核与KWS的1D-DS神经网络核同时集成到SoC上，最终综合的资源报告如下图所示  
贴图或者表

## 软件控制流程
Wujian100开源工程提供了官方的sdk，本实验采用了官方提供的usart驱动drv_usart.h，以实现音频数据从串口读入，从而减小了用于保存输入数据的RAM大小。  
整个软件控制流程如下图所示  
![Control-flow](http://10.134.141.124:8080/yintianyu/iaclab-zhihu/raw/master/figs/bchen/control_flow.png)

## FPGA的验证
用Vivado综合实现完成以后，生成了bitstream文件，按照官方指南将硬件烧写至开发板后，通过官方提供的CDK工具，将上一步实现的软件控制流程下载到开发板的stm32中，用于运行程序  
- **视频演示**  
贴视频
- **说明**  
由于uart采用RS232传输协议，最大波特率只有115200bps。因此目前速度瓶颈是**PC端与开发板之间音频输入数据的传输**。


## 后续工作
- **进一步优化神经网络**  
对于KWS神经网络的部分，一是可以通过**8bit量化**，**二值化**等方式进行压缩，以**减小资源消耗**。二是可以借鉴RNN-T等模型**提高模型预测准确度**。有关模型量化压缩、优化以及训练模型、验证模型的内容，
在下一篇帖子里会继续介绍。  
- **采用I2C协议传输音频输入数据**   
- **采用音频解码板输入真实语音数据测试**   
- **预处理算法的优化**   
